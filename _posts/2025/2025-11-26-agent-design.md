---
title: 多 Agent 架构的深度演进与设计范式
categories: Tech
tags: agent, ai
date: 2025-11-26
---

大模型（LLM）的应用开发正在经历一场静悄悄的范式转移：**从 Prompt Engineering（提示词工程）走向 Flow Engineering（工作流工程）**。

过去两年，我们一直试图通过优化 Prompt 来挖掘单个模型的极限潜力。但渐渐地，我们触碰到了单体智能的天花板：上下文窗口的物理限制、推理链路的性能衰减、以及跨领域知识的相互干扰。

破局的关键，在于**多 Agent 架构（Multi-Agent Architecture）**。这不仅仅是简单地组合多个 LLM，而是像设计人类组织一样，精心设计智能体之间的协作拓扑。

本文将尽量用简单的语言，深入探讨多 Agent 系统的核心设计范式。

## 一、为什么需要多 Agent?

单体 LLM 本质上是一个概率预测引擎，天然倾向于快思考（System 1）模式。而多 Agent 架构通过**分工与协作**，能够强制系统进入慢思考（System 2）状态。

其核心价值体现在解耦（Decoupling）上：

1. **上下文解耦**：当 Worker A 无需了解 Worker B 的任务细节时，我们可以大幅节省 Token 消耗，避免大海捞针式的信息检索
2. **能力解耦**：让擅长 SQL 的 Agent 专注于数据查询，让擅长文案的 Agent 专注于内容创作，专业的人做专业的事
3. **幻觉抑制**：通过"执行者"与"审查者"的制衡机制，以及多视角的交叉验证，显著降低模型幻觉

## 二、微观层面：Agent 的原子能力

在讨论宏观架构之前，我们先看构成系统的最小单元，单个 Agent 的运作模式。

### 1. PEER（Plan-Execute-Express-Review）

**定义**：这是 Agent 的内功心法，通过类 PDCA 的循环机制，赋予 Agent 自我修正的能力。

**价值**：这是 Agent 从"鹦鹉学舌"进化为"专业工匠"的关键。缺少 Review 环节的 Agent 是不可靠的。

### 2. DITR（Do It Then Review）

**定义**：一种先执行后审查的后处理策略，充分利用了 LLM "判别能力 > 生成能力" 的特性。

**价值**：这是提升输出质量性价比最高的方法，常用于单节点产出的质量优化。

## 三、宏观层面：组织架构的拓扑设计

多 Agent 系统的灵魂，在于智能体之间的连接方式。目前业界已沉淀出三种主流拓扑结构：

### 1. 层级监督模式（Hierarchical Supervisor）

**设计隐喻**：企业组织架构（管理者与执行者）

**运作机制**：设置一个 Supervisor（大脑）负责维护全局状态（State），根据当前进展动态路由到具体的 Worker（手脚）。Worker 执行完成后将结果返回给 Supervisor，彼此之间不直接交互。

**适用场景**：复杂工程任务，如全栈开发、大规模代码评审等

**架构评价**：这是**最稳健**的架构模式。它通过让 Supervisor 只保留任务摘要、Worker 只处理局部任务的方式，有效解决了长程任务中的上下文迷失问题。

### 2. 流水线融合模式（Sequential Fusion）—— DOE 范式

**设计隐喻**：精密装配生产线

**运作机制**：针对高精度、高专业度的内容生成需求，业界（如 agentUniverse）提出了 DOE（Data-fining，Opinion-inject，Express）模式：

- **D（Data-fining）**：专注于客观数据的清洗与校准，消除幻觉
- **O（Opinion-inject）**：专注于注入专家观点、标准流程或业务逻辑，提升深度
- **E（Express）**：专注于融合前两个阶段的产出，进行人性化表达，实现价值对齐

**适用场景**：研究报告生成、金融分析、严肃新闻写作等

**架构评价**：这种模式巧妙地解决了"既要准确又要深度"的矛盾，实现了**数据理性与观点感性**的分离与重组。

### 3. 协作研讨模式（Joint Collaboration）

**设计隐喻**：圆桌会议/头脑风暴

**运作机制**：多个 Agent 共享上下文，轮流发言或进行自由辩论。典型实现如 AutoGen 的 Group Chat。

**适用场景**：创意生成、对抗性模拟（红蓝军演习）、开放式问题探索等

**架构评价**：**涌现能力**最强，但也最不可控，Token 消耗最大。工业化落地需要谨慎评估。

### 其他潜在拓扑结构

我们从人类社会的合作模式可以推导出一些其他可能的拓扑结构。这些结构虽然在概念上更复杂，但它们可能代表了未来的方向。

#### 1. 市场竞价拓扑 (The Marketplace / Bidding Mechanism)

  * **哲学隐喻：** **自由市场经济**。
  * **核心逻辑：** 任务不是由“经理”指派的，而是由 Worker **抢单**的。
  * **运作方式：**
      * 用户发布一个任务。
      * Agent A（擅长代码）报价：“我有 90% 的信心能做，耗时 5 秒。”
      * Agent B（擅长文档）报价：“我有 10% 的信心。”
      * 系统（或环境）选择“报价（信心分数）”最优的 Agent 执行。
  * **价值：** 解决了“Supervisor 不懂谁最强”的问题。实现了资源的动态最优配置。

#### 2. 生物群体拓扑 (The Swarm / Emergence)

  * **哲学隐喻：** **蚁群或蜂群**。
  * **核心逻辑：** **去中心化、无领导、局部交互**。没有 Supervisor。
  * **运作方式：**
      * 每个 Agent 只有简单的规则（例如：“如果看到 Bug 就修”，“如果修不好就标记”）。
      * Agent 之间通过修改“环境”（比如代码库）来间接沟通，而不是直接对话。
      * **涌现 (Emergence)：** 宏观上，代码被神奇地修好了，尽管没有任何一个 Agent 拥有全局视图。
  * **价值：** 极高的**鲁棒性**。死掉一半 Agent，系统依然工作，只是变慢而已。

#### 3. 分形/递归拓扑 (The Fractal / Recursive)

  * **哲学隐喻：** **全息宇宙 / 俄罗斯套娃**。
  * **核心逻辑：** **自相似性**。
  * **运作方式：**
      * Agent A 接到一个任务，它发现任务太难，于是它**把自己复制**（或调用一个子 Agent 组），形成一个子系统。
      * 子系统里的 Agent 如果觉得还难，继续裂变。
      * 结构在宏观和微观上是一致的。
  * **价值：** 理论上可以处理**无限复杂度**的任务。

#### 4. 对抗拓扑 (The Generative Adversarial Network - GAN)

  * **哲学隐喻：** **法庭辩论 / 进化论（捕食者与猎物）**。
  * **核心逻辑：** **通过冲突寻求真理**。
  * **运作方式：**
      * Generator Agent 拼命生成“看起来像真的”代码/文章。
      * Discriminator Agent 拼命找茬，挑刺。
      * 两者在博弈中共同进化，直到 Critic 挑不出毛病。
  * **价值：** 这是目前**逼近完美质量**（SOTA）的最有效手段。

### 哪种最常用且最可靠？

虽然很多模型很迷人，但在**工业级落地**（追求 SLA、可调试、成本可控）的现实约束下，真正**最常用且最可靠**的拓扑只有一种，我称之为：

#### **“联邦制”架构 (The Federated Hierarchy)**

它其实是 **Supervisor（层级）** 和 **Router（路由）** 的结合体，有时也融合了 **Sequential（顺序）**。

**为什么它是“工业标准”？**

1.  **确定性 (Determinism)：** 企业应用最怕“不可预测”。Swarm（蚁群）和 Chat（群聊）太混沌了。联邦制架构下，数据流向是清晰的，出了错你能准确知道是哪个节点断了。
2.  **可观测性 (Observability)：** 有一个明确的 Supervisor 节点，你可以挂载日志、监控 Token 消耗、设置断点。
3.  **人类介入 (Human-in-the-loop)：** 这种结构天然适合插入人类审核节点。Supervisor 可以在派活前问人类：“我要派给 A 了，由于这涉及资金，请你批准。”

#### 可靠性排序和见解

如果我们按可靠性和落地频次排序，以下结论供参考：

| 排名 | 拓扑名称 | 协作本质 | 可靠性评价 | 适用场景 |
| :--- | :--- | :--- | :--- | :--- |
| **NO.1** | **Router + Sequential** <br> (路由+流水线) | **决定论** <br> (If-Then 逻辑) | **极其可靠**。路径是写死的，LLM 只做局部填空。 | 客服分流、SOP 执行、数据清洗。 |
| **NO.2** | **Hierarchical Supervisor** <br> (层级监督) | **科层制** <br> (官僚体系) |  **很可靠**。有明确的责权划分，状态可控。 | 复杂项目开发、长文写作、Code Review。 |
| **NO.3** | **Map-Reduce / Voting** <br> (并行投票) | **民主制** <br> (少数服从多数) |  **质量高**。通过冗余计算换取了准确性，很稳。 | 关键决策、代码生成、去幻觉。 |
| **NO.4** | **Joint Chat** <br> (协作群聊) | **无政府主义** <br> (自由讨论) |  **不可靠**。容易跑题、死循环，难以调试。 | 创意风暴、角色扮演游戏。 |

## 四、核心挑战：状态管理（State Management）

多 Agent 开发的本质，其实是**状态机的设计艺术**。

在使用 LangGraph 或 AutoGen 等框架时，开发者面临的最大挑战往往不是如何编写 Prompt，而是：**Agent 之间应该如何共享记忆？**

业界存在两种主流思路：

- **隔离派**：每个 Agent 只维护自己的短期记忆。资源消耗最小，适合层级监督模式
- **共享派**：所有 Agent 读写同一个"黑板"（Blackboard）。适合协作研讨模式，但容易导致上下文爆炸

**最佳实践**：采用**有限状态图（Finite State Graph）**设计模式。定义清晰的 `State Schema`（数据结构规范），明确规定哪些数据是全局追加型的（如 `logs`），哪些是局部覆盖型的（如 `current_task`）。

## 五、结语：Flow is All You Need

AI 应用开发的下半场，竞争的核心不再是谁的模型参数更大，而是谁的**架构设计更加精妙**。

未来的 AI 应用开发者，本质上是**组织架构设计师**。我们需要根据具体业务场景——是追求创意的发散性，还是追求精度的收敛性——灵活组合 **PEER 的个体能力**、**DOE 的流水线工艺**，在 **Supervisor 的统筹调度**下，构建出具备群体智能的数字化团队。

不要只做一个 Prompt Engineer，而要成长为一名 **Flow Engineer**。
